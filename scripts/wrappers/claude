#!/bin/bash
# Wrapper script for Claude Code CLI
# Installs on first use, checks for updates in background

set -euo pipefail

AGENT="claude"
STATE_DIR="${HOME}/.takopi-docker"
TIMESTAMP_FILE="${STATE_DIR}/last-update-${AGENT}"
UPDATE_INTERVAL=$((24 * 60 * 60))  # 24 hours in seconds

# Claude Code installs to ~/.claude/local/bin/claude
REAL_BINARY="${HOME}/.claude/local/bin/claude"

# Create state directory if needed
mkdir -p "${STATE_DIR}"

# Function to install Claude Code
install_agent() {
    echo "[takopi-docker] Installing Claude Code..."
    curl -fsSL https://claude.ai/install.sh | bash
    touch "${TIMESTAMP_FILE}"
}

# Function to update Claude Code in background
update_agent() {
    (
        curl -fsSL https://claude.ai/install.sh | bash >/dev/null 2>&1
        touch "${TIMESTAMP_FILE}"
    ) &
    disown
}

# Function to check if update needed
needs_update() {
    if [[ ! -f "${TIMESTAMP_FILE}" ]]; then
        return 0
    fi
    local last_update
    last_update=$(stat -c %Y "${TIMESTAMP_FILE}" 2>/dev/null || echo 0)
    local now
    now=$(date +%s)
    local age=$((now - last_update))
    [[ ${age} -gt ${UPDATE_INTERVAL} ]]
}

# Install if not present
if [[ ! -x "${REAL_BINARY}" ]]; then
    install_agent
fi

# Check for updates in background (non-blocking)
if needs_update; then
    echo "[takopi-docker] Checking for Claude Code updates in background..."
    update_agent
fi

# Execute the real binary
exec "${REAL_BINARY}" "$@"
